services:

  reverse-proxy:
    image: traefik:v2.11
    restart: unless-stopped
    command:
      - "--api.dashboard=false"
      - "--metrics.prometheus=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.file.filename=/etc/traefik/dynamic.yml"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.web.http.redirections.entryPoint.to=websecure"
      - "--entrypoints.web.http.redirections.entryPoint.scheme=https"
      - "--entrypoints.websecure.address=:443"
      - "--entrypoints.websecure.http.tls.certResolver=${TRAEFIK_CERT_RESOLVER}"
      - "--entrypoints.websecure.transport.respondingTimeouts.readTimeout=30s"
      - "--entrypoints.websecure.transport.respondingTimeouts.writeTimeout=30s"
      - "--entrypoints.websecure.transport.respondingTimeouts.idleTimeout=180s"
      - "--certificatesresolvers.letsencrypt.acme.tlschallenge=true"
      - "--certificatesresolvers.letsencrypt.acme.email=${ACME_EMAIL}"
      - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - "./letsencrypt:/letsencrypt"
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
      - "./traefik-dynamic.yml:/etc/traefik/dynamic.yml:ro"
    deploy:
      resources:
        limits:
          memory: 128M
    healthcheck:
      test: ["CMD", "traefik", "healthcheck", "--ping"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  prometheus:
    image: prom/prometheus:v3.8.1
    restart: unless-stopped
    volumes:
      - ./prometheus/:/etc/prometheus/
      - prometheus_data:/prometheus
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.prometheus.entrypoints=websecure"
      - "traefik.http.routers.prometheus.tls=true"
      - "traefik.http.routers.prometheus.tls.certresolver=${TRAEFIK_CERT_RESOLVER}"
      - "traefik.http.routers.prometheus.rule=Host(`prometheus.${DOMAIN}`)"
      - "traefik.http.routers.prometheus.middlewares=auth"
      - "traefik.http.middlewares.auth.basicauth.users=${TRAEFIK_BASIC_AUTH_USERS}"
    deploy:
      resources:
        limits:
          memory: 256M

  asynqmon:
    image: hibiken/asynqmon:latest
    restart: unless-stopped
    expose:
      - "8080"
    environment:
      - PORT=8080
      - REDIS_ADDR=redis:6379
      - REDIS_PASSWORD=
      - REDIS_DB=0
      - ENABLE_METRICS_EXPORTER=true
      - PROMETHEUS_ADDR=http://prometheus:9090
    depends_on:
      - redis
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.asynqmon.entrypoints=websecure"
      - "traefik.http.routers.asynqmon.tls=true"
      - "traefik.http.routers.asynqmon.tls.certresolver=${TRAEFIK_CERT_RESOLVER}"
      - "traefik.http.routers.asynqmon.rule=Host(`asynqmon.${DOMAIN}`)"
      - "traefik.http.routers.asynqmon.middlewares=auth"
      - "traefik.http.middlewares.auth.basicauth.users=${TRAEFIK_BASIC_AUTH_USERS}"
    deploy:
      resources:
        limits:
          memory: 64M

  kicad-server:
    image: admwscki/keyboard-tools-server:${TAG:-latest}
    restart: unless-stopped
    env_file:
      - production.env
    depends_on:
      - kicad-worker
      - redis
      - s3
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.kicad-server-https.entrypoints=websecure"
      - "traefik.http.routers.kicad-server-https.tls=true"
      - "traefik.http.routers.kicad-server-https.tls.certresolver=${TRAEFIK_CERT_RESOLVER}"
      - "traefik.http.routers.kicad-server-https.rule=Host(`kicad.${DOMAIN}`)"
      - "traefik.http.routers.kicad-server-https.middlewares=rate-limit@file"
    deploy:
      resources:
        limits:
          memory: 100M

  kicad-worker:
    image: admwscki/keyboard-tools-kicad:${TAG:-latest}
    restart: unless-stopped
    env_file:
      - production.env
    depends_on:
      - redis
      - s3
    deploy:
      resources:
        limits:
          memory: 400M

  redis:
    image: redis:6-alpine
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 100M
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  s3:
    image: chrislusf/seaweedfs:4.02
    restart: unless-stopped
    volumes:
      - s3_data:/data
    env_file:
      - production.env
    command: server -dir=/data -filer -filer.port=8888 -master.peers=none
    deploy:
      resources:
        limits:
          memory: 400M
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8888/"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s


volumes:
  s3_data:
  prometheus_data:

