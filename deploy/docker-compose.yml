services:

  reverse-proxy:
    image: traefik:v2.11
    command:
      - "--api.dashboard=false"
      - "--metrics.prometheus=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.web.http.redirections.entryPoint.to=websecure"
      - "--entrypoints.web.http.redirections.entryPoint.scheme=https"
      - "--entrypoints.websecure.address=:443"
      - "--entrypoints.websecure.http.tls.certResolver=${TRAEFIK_CERT_RESOLVER}"
      - "--certificatesresolvers.letsencrypt.acme.tlschallenge=true"
      - "--certificatesresolvers.letsencrypt.acme.email=${ACME_EMAIL}"
      - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - "./letsencrypt:/letsencrypt"
      - "/var/run/docker.sock:/var/run/docker.sock:ro"

  prometheus:
    image: prom/prometheus:v3.8.1
    volumes:
      - ./prometheus/:/etc/prometheus/
      - prometheus_data:/prometheus
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.prometheus.entrypoints=websecure"
      - "traefik.http.routers.prometheus.tls=true"
      - "traefik.http.routers.prometheus.rule=Host(`prometheus.${DOMAIN}`)"
      - "traefik.http.routers.prometheus.middlewares=auth"
      - "traefik.http.middlewares.auth.basicauth.users=${TRAEFIK_BASIC_AUTH_USERS}"

  asynqmon:
    image: hibiken/asynqmon:latest
    expose:
      - "8080"
    environment:
      - PORT=8080
      - REDIS_ADDR=redis:6379
      - REDIS_PASSWORD=
      - REDIS_DB=0
      - ENABLE_METRICS_EXPORTER=true
      - PROMETHEUS_ADDR=http://prometheus:9090
    depends_on:
      - redis
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.asynqmon.entrypoints=websecure"
      - "traefik.http.routers.asynqmon.tls=true"
      - "traefik.http.routers.asynqmon.rule=Host(`asynqmon.${DOMAIN}`)"
      - "traefik.http.routers.asynqmon.middlewares=auth"
      - "traefik.http.middlewares.auth.basicauth.users=${TRAEFIK_BASIC_AUTH_USERS}"

  landing-page:
    image: landing-page:latest
    build:
      context: ..
      dockerfile: deploy/Dockerfile
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.landing.entrypoints=websecure"
      - "traefik.http.routers.landing.tls=true"
      - "traefik.http.routers.landing.tls.certresolver=${TRAEFIK_CERT_RESOLVER}"
      - "traefik.http.routers.landing.rule=Host(`${DOMAIN}`)"

  kicad-server:
    image: admwscki/keyboard-tools-server:${TAG:-latest}
    env_file:
      - production.env
    depends_on:
      - kicad-worker
      - redis
      - s3
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.server.entrypoints=websecure"
      - "traefik.http.routers.server.tls=true"
      - "traefik.http.routers.server.tls.certresolver=${TRAEFIK_CERT_RESOLVER}"
      - "traefik.http.routers.server.rule=Host(`kicad.${DOMAIN}`)"

  kicad-worker:
    image: admwscki/keyboard-tools-kicad:${TAG:-latest}
    env_file:
      - production.env
    depends_on:
      - redis
      - s3

  redis:
    image: redis:6-alpine

  s3:
    image: chrislusf/seaweedfs:4.02
    volumes:
      - s3_data:/data
    env_file:
      - production.env
    command: server -dir=/data -filer -filer.port=8888 -master.peers=none


volumes:
  s3_data:
  prometheus_data:

